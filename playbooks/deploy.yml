---
- name: Deploy Azure Storage Account via Bicep
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    resource_group_name: "portfo-v2"
    location: "eastus2"
    storage_account_name: "storagesamueladebodun"
    # Points to main.bicep in the project root (one level up from playbooks/)
    bicep_file: "{{ playbook_dir }}/../main.bicep"

  tasks:
    - name: Create Resource Group
      ansible.builtin.command:
        cmd: az group create --name {{ resource_group_name }} --location {{ location }}
      register: rg_create
      changed_when: "'Succeeded' in rg_create.stdout"

    - name: Deploy Infrastructure (Bypass Python Module)
      ansible.builtin.command:
        cmd: >
          az deployment group create
          --resource-group {{ resource_group_name }}
          --name "ansible-bicep-deploy"
          --template-file {{ bicep_file }}
          --parameters storageAccountName={{ storage_account_name }} location={{ location }}
      register: cli_output
      changed_when: "'Running' in cli_output.stderr or 'Succeeded' in cli_output.stdout"

    - name: Show Deployment Output
      ansible.builtin.debug:
        msg: 
          - "Deployment Outputs:"
          - "{{ (cli_output.stdout | from_json).properties.outputs | default('No outputs') }}"
      # Only runs if the previous command returned valid JSON
      when: cli_output.stdout | length > 0