name: Deploy Cloud Resume

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  # --------------------------------------------------------------------------
  # JOB 1: Deploy Infrastructure (Bicep)
  # --------------------------------------------------------------------------
  deploy-infra:
    runs-on: ubuntu-latest
    outputs:
      function_app_name: ${{ steps.deploy.outputs.functionAppName }}
      storage_account_name: ${{ steps.deploy.outputs.storageAccountName }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        id: deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./main.bicep
          # Override the location to centralus here
          parameters: location=eastus

  # --------------------------------------------------------------------------
  # JOB 2: Build and Deploy Frontend (Astro -> Azure Storage)
  # --------------------------------------------------------------------------
  deploy-frontend:
    needs: deploy-infra
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Astro
        run: pnpm run build
        env:
          # Construct the API URL using the function app name output from Job 1
          PUBLIC_API_URL: https://${{ needs.deploy-infra.outputs.function_app_name }}.azurewebsites.net/api

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Storage ($web)
        uses: azure/CLI@v1
        with:
          # Use the dynamic storage account name output from Job 1
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ needs.deploy-infra.outputs.storage_account_name }} \
              --auth-mode key \
              -d '$web' \
              -s ./dist \
              --overwrite

  # --------------------------------------------------------------------------
  # JOB 3: Deploy Backend (Python -> Azure Functions)
  # --------------------------------------------------------------------------
  deploy-backend:
    needs: deploy-infra
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        shell: bash
        run: |
          pushd './api'
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          popd

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Function App
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.deploy-infra.outputs.function_app_name }}
          package: './api'